-- 서브 쿼리
-- select, from, where, having 절 쓸 수 있어야함

-- scalar sub query: 컬럼이 올 수 있는 곳에 사용한다.
-- 하나의 값만 출력 가능
-- select, update 문의 set절, order by 절에 사용가능
select a.nickname, (
select b.band_name
from firstschema.band as b join firstschema.store as s
on b.band_code = s.band_code
where s.ticket_id = a.ticket_id
)
from firstschema.audience a

-- inline view: from 절 등 테이블명이 올 수 있는 위치에 사용 가능
select a.nickname,
bs.band_name,
bs.performance_date
from firstschema.audience a, (
select band.band_name, store.performance_date
from firstschema.band join firstschema.store
on band.band_code = store.band_code
) as bs;

-- nexted subquery: where, having 절에 사용한다.
-- 메인 쿼리와의 관계에 따라서 비/연관 서브쿼리로 나눈다.
-- 비연관 서브쿼리
select a.nickname
from firstschema.audience a
where a.ticket_id = ( -- 서브쿼리 내 메인쿼리의 컬럼 없음
select ticket_id
from firstschema.store
where store.performance_name like '%Tour%'
order by store.performance_date
limit 1
)

-- 연관 서브쿼리
select a.nickname
from firstschema.audience a
where a.ticket_id = ( -- 서브쿼리 내 메인쿼리의 컬럼이 존재함
select ticket_id
from firstschema.store
where store.ticket_id = a.ticket_id
)

-- 중첩 서브쿼리 반환 형태에 따른 분류
-- 단일 행 (`=`, `<`, `>`, `<=`, `>=`, `<>`)

-- 다중 행 (SOME, IN, ALL, ANY, EXISTS)
-- 가장많이 공연하는 벤드 5개
select band*name,
(
select count(*) from store
where band.band*code = store.band_code
)
from band
where band_code in ( -- 다중 행
select store.band_code
from store
group by store.band_code
order by count(*) desc
limit 5
)

-- 다중 컬럼 (서브쿼리가 어러 컬럼 데이터 반환)
-- 밴드 리스트 중 보컬리스트
select \*
from band_member bm
where (bm.band_code , bm.member_role_code) in (
select b.band_code, br.code
from band_role br join band b
on bm.band_code = b.band_code
where br.code = 'VOC'
)

-- view: 재사용 가능한 select절, 인라인 뷰가 들어가는 위치에 이름을 기술하는 형태로 사용
create or replace view band_performance as
select band.band_name, store.performance_date
from firstschema.band join firstschema.store
on band.band_code = store.band_code;

select a.nickname,
bp.band_name,
bp.performance_date
from firstschema.audience a, band_performance as bp
